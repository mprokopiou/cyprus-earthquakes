<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cyprus Earthquake Live Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
        #map { width:100%; height:100%; }
        .controls {
            position: absolute; top:10px; left:10px; z-index:9999;
            background: rgba(255,255,255,0.9); padding:8px 12px; border-radius:12px;
            display:flex; gap:10px; align-items:center; font-size:14px;
        }
        .live { color:red; font-weight:bold; animation:blink 1s infinite; }
        @keyframes blink {50% { opacity:0; }}
        .countdown { font-size:12px; opacity:0.7; }
        .toggle-btn {
            position:absolute; right:10px; top:10px; z-index:9999;
            background: #ffffffcc; padding:8px 14px; border-radius:10px;
            cursor:pointer; font-weight:bold; border:1px solid #ccc;
        }
        .sidebar {
            position:absolute; right:0; top:0; width:260px; height:100%;
            background: rgba(255,255,255,0.95); padding:15px; z-index:9998; overflow-y:auto;
            border-left:2px solid #ddd;
        }
        .hidden { display:none; }
        .legend {
            position:absolute; bottom:20px; right:20px; z-index:9999;
            background: rgba(255,255,255,0.9); padding:10px; border-radius:10px;
            font-size:14px; border:1px solid #ccc;
        }
        .legend div { margin-bottom:5px; display:flex; align-items:center; gap:6px; }
        .color-box { width:14px; height:14px; border-radius:3px; display:inline-block; }
    </style>
</head>

<body>
<div id="controls" class="controls">
    <label for="range">Time Range:</label>
    <select id="range">
        <option value="1">Last 1 hour</option>
        <option value="6">Last 6 hours</option>
        <option value="12">Last 12 hours</option>
        <option value="24" selected>Last 24 hours</option>
        <option value="48">Last 48 hours</option>
    </select>
    <span id="live" class="live">‚óè LIVE</span>
    <span id="countdown" class="countdown"></span>
</div>

<div class="toggle-btn" onclick="toggleSidebar()">Panel</div>

<div id="sidebar" class="sidebar">
    <h3>Earthquake Info</h3>
    <p id="updated"></p>
</div>

<div id="map"></div>

<div class="legend">
    <div><span class="color-box" style="background: green;"></span> Newest</div>
    <div><span class="color-box" style="background: orange;"></span> Moderate age</div>
    <div><span class="color-box" style="background: red;"></span> Oldest</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([35.1,33.4],8);
let markersLayer = L.layerGroup().addTo(map);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);

let refreshInterval = 5*60*1000;
let remainingTime = refreshInterval/1000;
let countdownTimer;

function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("hidden");
}

// Build Seismic Portal URL dynamically
function buildSeismicUrl() {
    const hours = parseInt(document.getElementById("range").value);
    const end = new Date();
    const start = new Date(end.getTime() - hours*3600*1000);
    const startISO = start.toISOString().split(".")[0]+"Z";
    const endISO = end.toISOString().split(".")[0]+"Z";

    return `https://www.seismicportal.eu/fdsnws/event/1/query?format=json&starttime=${startISO}&endtime=${endISO}&minlat=34.4&maxlat=36.0&minlon=32.0&maxlon=35.0`;
}

// Load earthquakes from API
async function loadEarthquakes() {
    document.getElementById("live").style.opacity="1";
    const url = buildSeismicUrl();
    console.log("Fetching:", url);

    let data;
    try {
        const res = await fetch(url);
        data = await res.json();
    } catch(err) {
        alert("Error fetching earthquake data.");
        return;
    }

    if(!data || !data.features) {
        alert("Invalid data received from API.");
        return;
    }

    updateMap(data.features);

    const nowCY = new Date().toLocaleString("en-GB",{timeZone:"Europe/Nicosia"});
    document.getElementById("updated").innerHTML=`<b>Last updated:</b> ${nowCY}`;

    remainingTime = refreshInterval/1000;
}

// Determine marker color based on recency
function getColor(time, newest, oldest){
    const diff = time-oldest;
    const range = newest-oldest;
    if(range===0) return "green";
    const ratio = diff/range;
    if(ratio>0.66) return "green";
    if(ratio>0.33) return "orange";
    return "red";
}

// Update map markers
function updateMap(features){
    markersLayer.clearLayers();
    if(features.length===0){
        alert("No earthquakes in this range.");
        return;
    }
    const times = features.map(f=>f.properties.time);
    const newest = Math.max(...times);
    const oldest = Math.min(...times);

    features.forEach(eq=>{
        const [lon, lat, depth] = eq.geometry.coordinates;
        const timeUTC = eq.properties.time;
        const cyTime = new Date(timeUTC).toLocaleString("en-GB",{timeZone:"Europe/Nicosia"});
        const color = getColor(timeUTC,newest,oldest);

        const marker = L.circleMarker([lat,lon],{
            radius: Math.max(eq.properties.mag,3),
            color,
            fillColor:color,
            fillOpacity:0.8
        });

        marker.bindPopup(`
            <b>${eq.properties.flynn_region || eq.properties.place}</b><br>
            Magnitude: ${eq.properties.mag}<br>
            Time (CY): ${cyTime}<br>
            Depth: ${depth} km
        `);

        markersLayer.addLayer(marker);
    });
}

// Countdown for auto-refresh
function startCountdown(){
    countdownTimer = setInterval(()=>{
        remainingTime--;
        document.getElementById("countdown").innerText=`Refresh in ${remainingTime}s`;
        if(remainingTime<=0){ loadEarthquakes(); }
    },1000);
}

document.getElementById("range").addEventListener("change",()=>{ loadEarthquakes(); });

// Initial load
loadEarthquakes();
startCountdown();
setInterval(loadEarthquakes,refreshInterval);
</script>
</body>
</html>
