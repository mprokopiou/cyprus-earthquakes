<script>
const map = L.map("map").setView([35.0, 33.2], 8);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
}).addTo(map);

const url =
  "https://www.seismicportal.eu/fdsnws/event/1/query?format=json&starttime=2025-11-12T00:00:00&minlat=34.4&maxlat=36.0&minlon=32.0&maxlon=35.0";

fetch(url)
  .then((res) => res.json())
  .then((data) => {
    if (!data.features) {
      alert("No earthquake data found!");
      return;
    }

    const earthquakes = data.features.map((f) => ({
      place: f.properties.flynn_region,
      mag: f.properties.mag,
      time: new Date(f.properties.time),
      lat: f.geometry.coordinates[1],
      lon: f.geometry.coordinates[0],
    }));

    // Sort by time (newest first)
    earthquakes.sort((a, b) => b.time - a.time);

    const now = new Date();

    earthquakes.forEach((eq, index) => {
      const hoursOld = (now - eq.time) / 1000 / 60 / 60;

      let color = "green";
      if (hoursOld > 24) color = "orange";
      if (hoursOld > 72) color = "red";

      const marker = L.circleMarker([eq.lat, eq.lon], {
        radius: Math.max(eq.mag, 3),
        color,
        fillColor: color,
        fillOpacity: 0.6,
      }).addTo(map);

      const cyTime = eq.time.toLocaleString("en-GB", {
        timeZone: "Europe/Athens",
        dateStyle: "medium",
        timeStyle: "short",
      });

      marker.bindPopup(
        `<b>${eq.place}</b><br>
         Magnitude: ${eq.mag}<br>
         Time (Cyprus): ${cyTime}`
      );

      if (index === 0) marker.openPopup();
    });
  })
  .catch((err) => console.error(err));

// --- Persistent Legend (Always Visible) ---
const legend = document.createElement("div");
legend.innerHTML = `
  <div id="legend" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 13px;
    line-height: 1.5;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 1000;
  ">
    <b>Legend:</b><br>
    ðŸŸ¢ <span>Recent (last 24h)</span><br>
    ðŸŸ  <span>Old (1â€“3 days)</span><br>
    ðŸ”´ <span>Very old (&gt;3 days)</span>
  </div>
`;
document.body.appendChild(legend);
</script>
