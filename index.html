<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Cyprus Earthquake Live Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<style>
    body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
    #map { width:100%; height:100%; }
    .controls {
        position:absolute; top:10px; left:10px; z-index:9999;
        background:#fff; padding:8px 12px; border-radius:12px;
        display:flex; gap:10px; align-items:center; font-size:14px;
        box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .live { color:red; font-weight:bold; animation:blink 1s infinite; }
    @keyframes blink {50% { opacity:0; }}
    .countdown { font-size:12px; opacity:0.7; }
    .toggle-btn {
        position:absolute; right:10px; top:10px; z-index:9999;
        background:#fff; padding:8px 14px; border-radius:10px;
        cursor:pointer; font-weight:bold; border:1px solid #ccc;
    }
    .sidebar {
        position:absolute; right:0; top:0; width:280px; height:100%;
        background:#fff; padding:15px; z-index:9998; overflow-y:auto;
        border-left:2px solid #ddd; box-shadow:-2px 0 6px rgba(0,0,0,0.1);
    }
    .hidden { display:none; }
    .legend {
        position:absolute; bottom:20px; right:20px; z-index:9999;
        background:#fff; padding:10px; border-radius:10px;
        font-size:14px; border:1px solid #ccc;
    }
    .legend div { margin-bottom:5px; display:flex; align-items:center; gap:6px; }
    .color-box { width:14px; height:14px; border-radius:3px; display:inline-block; }
    .loading { text-align:center; font-size:14px; color:#666; }
    .quake-item { padding:6px; border-bottom:1px solid #eee; cursor:pointer; }
    .quake-item:hover { background:#f9f9f9; }
</style>
</head>
<body>
<div id="controls" class="controls">
    <label for="range">Time Range:</label>
    <select id="range">
        <option value="1">Last 1 hour</option>
        <option value="6">Last 6 hours</option>
        <option value="12">Last 12 hours</option>
        <option value="24" selected>Last 24 hours</option>
        <option value="48">Last 48 hours</option>
    </select>
    <label for="magFilter">Min Magnitude:</label>
    <input type="range" id="magFilter" min="0" max="6" step="0.1" value="0">
    <span id="magValue">0</span>
    <span id="live" class="live">‚óè LIVE</span>
    <span id="countdown" class="countdown"></span>
</div>

<div class="toggle-btn" onclick="toggleSidebar()">Panel</div>

<div id="sidebar" class="sidebar">
    <h3>Earthquake Info</h3>
    <p id="updated"></p>
    <div id="loading" class="loading">Loading data...</div>
    <div id="quakeList"></div>
</div>

<div id="map"></div>

<div class="legend">
    <div><span class="color-box" style="background: green;"></span> Newest</div>
    <div><span class="color-box" style="background: orange;"></span> Moderate age</div>
    <div><span class="color-box" style="background: red;"></span> Oldest</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
let map = L.map('map').setView([35.1,33.4],8);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);

let markersLayer = L.markerClusterGroup();
map.addLayer(markersLayer);

let refreshInterval = 5*60*1000;
let remainingTime = refreshInterval/1000;
let countdownTimer;
let quakeData = [];

function toggleSidebar() {
    document.getElementById("sidebar").classList.toggle("hidden");
}

function buildSeismicUrl() {
    const hours = parseInt(document.getElementById("range").value);
    const end = new Date();
    const start = new Date(end.getTime() - hours*3600*1000);
    const startISO = start.toISOString().split(".")[0]+"Z";
    const endISO = end.toISOString().split(".")[0]+"Z";
    return `https://www.seismicportal.eu/fdsnws/event/1/query?format=json&starttime=${startISO}&endtime=${endISO}&minlat=34.4&maxlat=36.0&minlon=32.0&maxlon=35.0`;
}

async function loadEarthquakes() {
    document.getElementById("loading").style.display="block";
    document.getElementById("quakeList").innerHTML="";
    const url = buildSeismicUrl();
    try {
        const res = await fetch(url);
        const data = await res.json();
        quakeData = data.features || [];
        updateMap(quakeData);
        updateSidebar(quakeData);
        const nowCY = new Date().toLocaleString("en-GB",{timeZone:"Europe/Nicosia"});
        document.getElementById("updated").innerHTML=`<b>Last updated:</b> ${nowCY}`;
    } catch(err) {
        document.getElementById("quakeList").innerHTML="<p style='color:red;'>Error fetching data.</p>";
    }
    document.getElementById("loading").style.display="none";
    remainingTime = refreshInterval/1000;
}

function getColor(time){
    const now = new Date();
    const diffHours = (now - new Date(time)) / (1000 * 60 * 60);
    if(diffHours <= 1) return "green";
    if(diffHours <= 6) return "orange";
    return "red";
}

function updateMap(features){
    markersLayer.clearLayers();
    const minMag = parseFloat(document.getElementById("magFilter").value);
    features.filter(eq => eq.properties.mag >= minMag).forEach(eq=>{
        const [lon, lat, depth] = eq.geometry.coordinates;
        const timeUTC = eq.properties.time;
        const cyTime = new Date(timeUTC).toLocaleString("en-GB",{timeZone:"Europe/Nicosia"});
        const color = getColor(timeUTC);
        const marker = L.circleMarker([lat,lon],{
            radius: Math.max(eq.properties.mag,3),
            color, fillColor:color, fillOpacity:0.8
        }).bindPopup(`
            <b>${eq.properties.flynn_region || eq.properties.place}</b><br>
            Magnitude: ${eq.properties.mag}<br>
            Time (CY): ${cyTime}<br>
            Depth: ${depth} km
        `);
        markersLayer.addLayer(marker);
    });
}

function updateSidebar(features){
    const list = document.getElementById("quakeList");
    if(features.length===0){ list.innerHTML="<p>No earthquakes in this range.</p>"; return; }
    const minMag = parseFloat(document.getElementById("magFilter").value);
    features.filter(eq => eq.properties.mag >= minMag).forEach(eq=>{
        const cyTime = new Date(eq.properties.time).toLocaleString("en-GB",{timeZone:"Europe/Nicosia"});
        const item = document.createElement("div");
        item.className="quake-item";
        item.innerHTML=`<b>${eq.properties.mag}</b> | ${eq.properties.flynn_region || eq.properties.place}<br><small>${cyTime}</small>`;
        item.onclick=()=>{ map.setView([eq.geometry.coordinates[1], eq.geometry.coordinates[0]],10); };
        list.appendChild(item);
    });
}

function startCountdown(){
    countdownTimer = setInterval(()=>{
        remainingTime--;
        document.getElementById("countdown").innerText=`Refresh in ${remainingTime}s`;
        if(remainingTime<=0){ loadEarthquakes(); }
    },1000);
}

document.getElementById("range").addEventListener("change",()=>{ loadEarthquakes(); });
document.getElementById("magFilter").addEventListener("input",()=>{
    document.getElementById("magValue").innerText=document.getElementById("magFilter").value;
    updateMap(quakeData);
    updateSidebar(quakeData);
});

loadEarthquakes();
startCountdown();
setInterval(loadEarthquakes,refreshInterval);
</script>
</body>
</html>
